{
	"nodes":[
		{"id":"4a3a95e7602a752d","x":-185,"y":9996,"width":250,"height":60,"type":"text","text":""},
		{"id":"1bf9ccb161c3e5d4","type":"text","text":"## FTP Footprinting","x":-400,"y":-680,"width":460,"height":60},
		{"id":"9a42148afd56e8a9","type":"text","text":"## FTP Exercise","x":880,"y":-720,"width":523,"height":85},
		{"id":"ac9bc44cb388c8be","type":"text","text":"10.129.202.5\n\n---\n### TTP question 1:\nWhich version of the FTP server is running on the target system? Submit the entire banner as the answer.\n\n\tnc -nv 10.129.202.5 21\n\n**220 InFreight FTP v1.1**\n\nexcluded the 220 ftp message and it worked)\n\n\n\n\n### TTP question 2:\nEnumerate the FTP server and find the flag.txt file. Submit the contents of it as the answer.\n\n\twget -m --no-passive ftp://anonymous:anonymous@10.129.202.5\n\n(this downloaded entire ftp directory to local pwd)\n\nflag downloaded:\n**HTB{b7skjr4c76zhsds7fzhd4k3ujg7nhdjre}**","x":880,"y":-580,"width":1040,"height":1300},
		{"id":"ff0d917aa4de919b","type":"text","text":"The `File Transfer Protocol` (`FTP`) is one of the oldest protocols on the Internet. The FTP runs within the application layer of the TCP/IP protocol stack. Thus, it is on the same layer as `HTTP` or `POP`. These protocols also work with the support of browsers or email clients to perform their services. There are also special FTP programs for the File Transfer Protocol.\n\nLet us imagine that we want to upload local files to a server and download other files using the [FTP](https://datatracker.ietf.org/doc/html/rfc959) protocol. In an FTP connection, two channels are opened. First, the client and server establish a control channel through `TCP port 21`. The client sends commands to the server, and the server returns status codes. Then both communication participants can establish the data channel via `TCP port 20`. This channel is used exclusively for data transmission, and the protocol watches for errors during this process. If a connection is broken off during transmission, the transport can be resumed after re-established contact.\n\nA distinction is made between `active` and `passive` FTP. In the active variant, the client establishes the connection as described via TCP port 21 and thus informs the server via which client-side port the server can transmit its responses. However, if a firewall protects the client, the server cannot reply because all external connections are blocked. For this purpose, the `passive mode` has been developed. Here, the server announces a port through which the client can establish the data channel. Since the client initiates the connection in this method, the firewall does not block the transfer.\n\nThe FTP knows different [commands](https://web.archive.org/web/20230326204635/https://www.smartfile.com/blog/the-ultimate-ftp-commands-list/) and status codes. Not all of these commands are consistently implemented on the server. For example, the client-side instructs the server-side to upload or download files, organize directories or delete files. The server responds in each case with a status code that indicates whether the command was successfully implemented. A list of possible status codes can be found [here](https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes).\n\nUsually, we need credentials to use FTP on a server. We also need to know that FTP is a `clear-text` protocol that can sometimes be sniffed if conditions on the network are right. However, there is also the possibility that a server offers `anonymous FTP`. The server operator then allows any user to upload or download files via FTP without using a password. Since there are security risks associated with such a public FTP server, the options for users are usually limited.\n\n---\n\n## TFTP\n\n`Trivial File Transfer Protocol` (`TFTP`) is simpler than FTP and performs file transfers between client and server processes. However, it `does not` provide user authentication and other valuable features supported by FTP. In addition, while FTP uses TCP, TFTP uses `UDP`, making it an unreliable protocol and causing it to use UDP-assisted application layer recovery.\n\nThis is reflected, for example, in the fact that TFTP, unlike FTP, does not require the user's authentication. It does not support protected login via passwords and sets limits on access based solely on the read and write permissions of a file in the operating system. Practically, this leads to TFTP operating exclusively in directories and with files that have been shared with all users and can be read and written globally. Because of the lack of security, TFTP, unlike FTP, may only be used in local and protected networks.\n\nLet us take a look at a few commands of `TFTP`:\n\n|**Commands**|**Description**|\n|---|---|\n|`connect`|Sets the remote host, and optionally the port, for file transfers.|\n|`get`|Transfers a file or set of files from the remote host to the local host.|\n|`put`|Transfers a file or set of files from the local host onto the remote host.|\n|`quit`|Exits tftp.|\n|`status`|Shows the current status of tftp, including the current transfer mode (ascii or binary), connection status, time-out value, and so on.|\n|`verbose`|Turns verbose mode, which displays additional information during file transfer, on or off.|\n\nUnlike the FTP client, `TFTP` does not have directory listing functionality.\n\n---\n\n## Default Configuration\n\nOne of the most used FTP servers on Linux-based distributions is [vsFTPd](https://security.appspot.com/vsftpd.html). The default configuration of vsFTPd can be found in `/etc/vsftpd.conf`, and some settings are already predefined by default. It is highly recommended to install the vsFTPd server on a VM and have a closer look at this configuration.\n\n#### Install vsFTPd\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ sudo apt install vsftpd \n```\n\nThe vsFTPd server is only one of a few FTP servers available to us. There are many different alternatives to it, which also bring, among other things, many more functions and configuration options with them. We will use the vsFTPd server because it is an excellent way to show the configuration possibilities of an FTP server in a simple and easy-to-understand way without going into the details of the man pages. If we look at the configuration file of vsFTPd, we will see many options and settings that are either commented or commented out. However, the configuration file does not contain all possible settings that can be made. The existing and missing ones can be found on the [man page](http://vsftpd.beasts.org/vsftpd_conf.html).\n\n#### vsFTPd Config File\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ cat /etc/vsftpd.conf | grep -v \"#\"\n```\n\n|**Setting**|**Description**|\n|---|---|\n|`listen=NO`|Run from inetd or as a standalone daemon?|\n|`listen_ipv6=YES`|Listen on IPv6 ?|\n|`anonymous_enable=NO`|Enable Anonymous access?|\n|`local_enable=YES`|Allow local users to login?|\n|`dirmessage_enable=YES`|Display active directory messages when users go into certain directories?|\n|`use_localtime=YES`|Use local time?|\n|`xferlog_enable=YES`|Activate logging of uploads/downloads?|\n|`connect_from_port_20=YES`|Connect from port 20?|\n|`secure_chroot_dir=/var/run/vsftpd/empty`|Name of an empty directory|\n|`pam_service_name=vsftpd`|This string is the name of the PAM service vsftpd will use.|\n|`rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem`|The last three options specify the location of the RSA certificate to use for SSL encrypted connections.|\n|`rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key`||\n|`ssl_enable=NO`||\n\nIn addition, there is a file called `/etc/ftpusers` that we also need to pay attention to, as this file is used to deny certain users access to the FTP service. In the following example, the users `guest`, `john`, and `kevin` are not permitted to log in to the FTP service, even if they exist on the Linux system.\n\n#### FTPUSERS\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ cat /etc/ftpusers\n\nguest\njohn\nkevin\n```\n\n---\n\n## Dangerous Settings\n\nThere are many different security-related settings we can make on each FTP server. These can have various purposes, such as testing connections through the firewalls, testing routes, and authentication mechanisms. One of these authentication mechanisms is the `anonymous` user. This is often used to allow everyone on the internal network to share files and data without accessing each other's computers. With vsFTPd, the [optional settings](http://vsftpd.beasts.org/vsftpd_conf.html) that can be added to the configuration file for the anonymous login look like this:\n\n|**Setting**|**Description**|\n|---|---|\n|`anonymous_enable=YES`|Allowing anonymous login?|\n|`anon_upload_enable=YES`|Allowing anonymous to upload files?|\n|`anon_mkdir_write_enable=YES`|Allowing anonymous to create new directories?|\n|`no_anon_password=YES`|Do not ask anonymous for password?|\n|`anon_root=/home/username/ftp`|Directory for anonymous.|\n|`write_enable=YES`|Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE?|\n\nWith the standard FTP client (`ftp`), we can access the FTP server accordingly and log in with the anonymous user if the settings shown above have been used. The use of the anonymous account can occur in internal environments and infrastructures where the participants are all known. Access to this type of service can be set temporarily or with the setting to accelerate the exchange of files.\n\nAs soon as we connect to the vsFTPd server, the `response code 220` is displayed with the banner of the FTP server. Often this banner contains the description of the `service` and even the `version` of it. It also tells us what type of system the FTP server is. One of the most common configurations of FTP servers is to allow `anonymous` access, which does not require legitimate credentials but provides access to some files. Even if we cannot download them, sometimes just listing the contents is enough to generate further ideas and note down information that will help us in another approach.\n\n#### Anonymous Login\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ ftp 10.129.14.136\n\nConnected to 10.129.14.136.\n220 \"Welcome to the HTB Academy vsFTP service.\"\nName (10.129.14.136:cry0l1t3): anonymous\n\n230 Login successful.\nRemote system type is UNIX.\nUsing binary mode to transfer files.\n\n\nftp> ls\n\n200 PORT command successful. Consider using PASV.\n150 Here comes the directory listing.\n-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx\ndrwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Clients\ndrwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents\ndrwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees\n-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt\n226 Directory send OK.\n\n```\n\nHowever, to get the first overview of the server's settings, we can use the following command:\n\n#### vsFTPd Status\n\n  FTP\n\n```shell-session\nftp> status\n\nConnected to 10.129.14.136.\nNo proxy connection.\nConnecting using address family: any.\nMode: stream; Type: binary; Form: non-print; Structure: file\nVerbose: on; Bell: off; Prompting: on; Globbing: on\nStore unique: off; Receive unique: off\nCase: off; CR stripping: on\nQuote control characters: on\nNtrans: off\nNmap: off\nHash mark printing: off; Use of PORT cmds: on\nTick counter printing: off\n```\n\nSome commands should be used occasionally, as these will make the server show us more information that we can use for our purposes. These commands include `debug` and `trace`.\n\n#### vsFTPd Detailed Output\n\n  FTP\n\n```shell-session\nftp> debug\n\nDebugging on (debug=1).\n\n\nftp> trace\n\nPacket tracing on.\n\n\nftp> ls\n\n---> PORT 10,10,14,4,188,195\n200 PORT command successful. Consider using PASV.\n---> LIST\n150 Here comes the directory listing.\n-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx\ndrwxrwxr-x    2 1002     1002         4096 Sep 14 17:03 Clients\ndrwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents\ndrwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees\n-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt\n226 Directory send OK.\n```\n\n| **Setting**               | **Description**                                                        |\n| ------------------------- | ---------------------------------------------------------------------- |\n| `dirmessage_enable=YES`   | Show a message when they first enter a new directory?                  |\n| `chown_uploads=YES`       | Change ownership of anonymously uploaded files?                        |\n| `chown_username=username` | User who is given ownership of anonymously uploaded files.             |\n| `local_enable=YES`        | Enable local users to login?                                           |\n| `chroot_local_user=YES`   | Place local users into their home directory?                           |\n| `chroot_list_enable=YES`  | Use a list of local users that will be placed in their home directory? |\n\n|**Setting**|**Description**|\n|---|---|\n|`hide_ids=YES`|All user and group information in directory listings will be displayed as \"ftp\".|\n|`ls_recurse_enable=YES`|Allows the use of recurse listings.|\n\nIn the following example, we can see that if the `hide_ids=YES` setting is present, the UID and GUID representation of the service will be overwritten, making it more difficult for us to identify with which rights these files are written and uploaded.\n\n#### Hiding IDs - YES\n\n  FTP\n\n```shell-session\nftp> ls\n\n---> TYPE A\n200 Switching to ASCII mode.\nftp: setsockopt (ignored): Permission denied\n---> PORT 10,10,14,4,223,101\n200 PORT command successful. Consider using PASV.\n---> LIST\n150 Here comes the directory listing.\n-rw-rw-r--    1 ftp     ftp      8138592 Sep 14 16:54 Calender.pptx\ndrwxrwxr-x    2 ftp     ftp         4096 Sep 14 17:03 Clients\ndrwxrwxr-x    2 ftp     ftp         4096 Sep 14 16:50 Documents\ndrwxrwxr-x    2 ftp     ftp         4096 Sep 14 16:50 Employees\n-rw-rw-r--    1 ftp     ftp           41 Sep 14 16:45 Important Notes.txt\n-rw-------    1 ftp     ftp            0 Sep 15 14:57 testupload.txt\n226 Directory send OK.\n```\n\nThis setting is a security feature to prevent local usernames from being revealed. With the usernames, we could attack the services like FTP and SSH and many others with a brute-force attack in theory. However, in reality, [fail2ban](https://en.wikipedia.org/wiki/Fail2ban) solutions are now a standard implementation of any infrastructure that logs the IP address and blocks all access to the infrastructure after a certain number of failed login attempts.\n\nAnother helpful setting we can use for our purposes is the `ls_recurse_enable=YES`. This is often set on the vsFTPd server to have a better overview of the FTP directory structure, as it allows us to see all the visible content at once.\n\n#### Recursive Listing\n\n  FTP\n\n```shell-session\nftp> ls -R\n\n---> PORT 10,10,14,4,222,149\n200 PORT command successful. Consider using PASV.\n---> LIST -R\n150 Here comes the directory listing.\n.:\n-rw-rw-r--    1 ftp      ftp      8138592 Sep 14 16:54 Calender.pptx\ndrwxrwxr-x    2 ftp      ftp         4096 Sep 14 17:03 Clients\ndrwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Documents\ndrwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Employees\n-rw-rw-r--    1 ftp      ftp           41 Sep 14 16:45 Important Notes.txt\n-rw-------    1 ftp      ftp            0 Sep 15 14:57 testupload.txt\n\n./Clients:\ndrwx------    2 ftp      ftp          4096 Sep 16 18:04 HackTheBox\ndrwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:00 Inlanefreight\n\n./Clients/HackTheBox:\n-rw-r--r--    1 ftp      ftp         34872 Sep 16 18:04 appointments.xlsx\n-rw-r--r--    1 ftp      ftp        498123 Sep 16 18:04 contract.docx\n-rw-r--r--    1 ftp      ftp        478237 Sep 16 18:04 contract.pdf\n-rw-r--r--    1 ftp      ftp           348 Sep 16 18:04 meetings.txt\n\n./Clients/Inlanefreight:\n-rw-r--r--    1 ftp      ftp         14211 Sep 16 18:00 appointments.xlsx\n-rw-r--r--    1 ftp      ftp         37882 Sep 16 17:58 contract.docx\n-rw-r--r--    1 ftp      ftp            89 Sep 16 17:58 meetings.txt\n-rw-r--r--    1 ftp      ftp        483293 Sep 16 17:59 proposal.pptx\n\n./Documents:\n-rw-r--r--    1 ftp      ftp         23211 Sep 16 18:05 appointments-template.xlsx\n-rw-r--r--    1 ftp      ftp         32521 Sep 16 18:05 contract-template.docx\n-rw-r--r--    1 ftp      ftp        453312 Sep 16 18:05 contract-template.pdf\n\n./Employees:\n226 Directory send OK.\n\n```\n\n`Downloading` files from such an FTP server is one of the main features, as well as `uploading` files created by us. This allows us, for example, to use LFI vulnerabilities to make the host execute system commands. Apart from the files, we can view, download and inspect. Attacks are also possible with the FTP logs, leading to `Remote Command Execution` (`RCE`). This applies to the FTP services and all those we can detect during our enumeration phase.\n\n#### Download a File\n\n  FTP\n\n```shell-session\nftp> ls\n\n200 PORT command successful. Consider using PASV.\n150 Here comes the directory listing.\n-rwxrwxrwx    1 ftp      ftp             0 Sep 16 17:24 Calendar.pptx\ndrwxrwxrwx    4 ftp      ftp          4096 Sep 16 17:57 Clients\ndrwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:05 Documents\ndrwxrwxrwx    2 ftp      ftp          4096 Sep 16 17:24 Employees\n-rwxrwxrwx    1 ftp      ftp            41 Sep 18 15:58 Important Notes.txt\n226 Directory send OK.\n\n\nftp> get Important\\ Notes.txt\n\nlocal: Important Notes.txt remote: Important Notes.txt\n200 PORT command successful. Consider using PASV.\n150 Opening BINARY mode data connection for Important Notes.txt (41 bytes).\n226 Transfer complete.\n41 bytes received in 0.00 secs (606.6525 kB/s)\n\n\nftp> exit\n\n221 Goodbye.\n```\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ ls | grep Notes.txt\n\n'Important Notes.txt'\n```\n\nWe also can download all the files and folders we have access to at once. This is especially useful if the FTP server has many different files in a larger folder structure. However, this can cause alarms because no one from the company usually wants to download all files and content all at once.\n\n#### Download All Available Files\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136\n\n--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/                                         \n           => ‘10.129.14.136/.listing’                                                                     \nConnecting to 10.129.14.136:21... connected.                                                               \nLogging in as anonymous ... Logged in!\n==> SYST ... done.    ==> PWD ... done.\n==> TYPE I ... done.  ==> CWD not needed.\n==> PORT ... done.    ==> LIST ... done.                                                                 \n12.12.1.136/.listing           [ <=>                                  ]     466  --.-KB/s    in 0s       \n                                                                                                         \n2021-09-19 14:45:58 (65,8 MB/s) - ‘10.129.14.136/.listing’ saved [466]                                     \n--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/Calendar.pptx   \n           => ‘10.129.14.136/Calendar.pptx’                                       \n==> CWD not required.                                                           \n==> SIZE Calendar.pptx ... done.                                                                                                                            \n==> PORT ... done.    ==> RETR Calendar.pptx ... done.       \n\n...SNIP...\n\n2021-09-19 14:45:58 (48,3 MB/s) - ‘10.129.14.136/Employees/.listing’ saved [119]\n\nFINISHED --2021-09-19 14:45:58--\nTotal wall clock time: 0,03s\nDownloaded: 15 files, 1,7K in 0,001s (3,02 MB/s)\n```\n\nOnce we have downloaded all the files, `wget` will create a directory with the name of the IP address of our target. All downloaded files are stored there, which we can then inspect locally.\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ tree .\n\n.\n└── 10.129.14.136\n    ├── Calendar.pptx\n    ├── Clients\n    │   └── Inlanefreight\n    │       ├── appointments.xlsx\n    │       ├── contract.docx\n    │       ├── meetings.txt\n    │       └── proposal.pptx\n    ├── Documents\n    │   ├── appointments-template.xlsx\n    │   ├── contract-template.docx\n    │   └── contract-template.pdf\n    ├── Employees\n    └── Important Notes.txt\n\n5 directories, 9 files\n```\n\nNext, we can check if we have the permissions to upload files to the FTP server. Especially with web servers, it is common that files are synchronized, and the developers have quick access to the files. FTP is often used for this purpose, and most of the time, configuration errors are found on servers that the administrators think are not discoverable. The attitude that internal network components cannot be accessed from the outside means that the hardening of internal systems is often neglected and leads to misconfigurations.\n\nThe ability to upload files to the FTP server connected to a web server increases the likelihood of gaining direct access to the webserver and even a reverse shell that allows us to execute internal system commands and perhaps even escalate our privileges.\n\n#### Upload a File\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ touch testupload.txt\n```\n\nWith the `PUT` command, we can upload files in the current folder to the FTP server.\n\n  FTP\n\n```shell-session\nftp> put testupload.txt \n\nlocal: testupload.txt remote: testupload.txt\n---> PORT 10,10,14,4,184,33\n200 PORT command successful. Consider using PASV.\n---> STOR testupload.txt\n150 Ok to send data.\n226 Transfer complete.\n\n\nftp> ls\n\n---> TYPE A\n200 Switching to ASCII mode.\n---> PORT 10,10,14,4,223,101\n200 PORT command successful. Consider using PASV.\n---> LIST\n150 Here comes the directory listing.\n-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx\ndrwxrwxr-x    2 1002     1002         4096 Sep 14 17:03 Clients\ndrwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents\ndrwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees\n-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt\n-rw-------    1 1002     133             0 Sep 15 14:57 testupload.txt\n226 Directory send OK.\n\n```\n\n---\n\n## Footprinting the Service\n\nFootprinting using various network scanners is also a handy and widespread approach. These tools make it easier for us to identify different services, even if they are not accessible on standard ports. One of the most widely used tools for this purpose is Nmap. Nmap also brings the [Nmap Scripting Engine](https://nmap.org/book/nse.html) (`NSE`), a set of many different scripts written for specific services. More information on the capabilities of Nmap and NSE can be found in the [Network Enumeration with Nmap](https://academy.hackthebox.com/course/preview/network-enumeration-with-nmap) module. We can update this database of NSE scripts with the command shown.\n\n#### Nmap FTP Scripts\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ sudo nmap --script-updatedb\n\nStarting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 13:49 CEST\nNSE: Updating rule database.\nNSE: Script Database updated successfully.\nNmap done: 0 IP addresses (0 hosts up) scanned in 0.28 seconds\n```\n\nAll the NSE scripts are located on the Pwnbox in `/usr/share/nmap/scripts/`, but on our systems, we can find them using a simple command.\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ find / -type f -name ftp* 2>/dev/null | grep scripts\n\n/usr/share/nmap/scripts/ftp-syst.nse\n/usr/share/nmap/scripts/ftp-vsftpd-backdoor.nse\n/usr/share/nmap/scripts/ftp-vuln-cve2010-4221.nse\n/usr/share/nmap/scripts/ftp-proftpd-backdoor.nse\n/usr/share/nmap/scripts/ftp-bounce.nse\n/usr/share/nmap/scripts/ftp-libopie.nse\n/usr/share/nmap/scripts/ftp-anon.nse\n/usr/share/nmap/scripts/ftp-brute.nse\n```\n\nAs we already know, the FTP server usually runs on the standard TCP port 21, which we can scan using Nmap. We also use the version scan (`-sV`), aggressive scan (`-A`), and the default script scan (`-sC`) against our target `10.129.14.136`.\n\n#### Nmap\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ sudo nmap -sV -p21 -sC -A 10.129.14.136\n\nStarting Nmap 7.80 ( https://nmap.org ) at 2021-09-16 18:12 CEST\nNmap scan report for 10.129.14.136\nHost is up (0.00013s latency).\n\nPORT   STATE SERVICE VERSION\n21/tcp open  ftp     vsftpd 2.0.8 or later\n| ftp-anon: Anonymous FTP login allowed (FTP code 230)\n| -rwxrwxrwx    1 ftp      ftp       8138592 Sep 16 17:24 Calendar.pptx [NSE: writeable]\n| drwxrwxrwx    4 ftp      ftp          4096 Sep 16 17:57 Clients [NSE: writeable]\n| drwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:05 Documents [NSE: writeable]\n| drwxrwxrwx    2 ftp      ftp          4096 Sep 16 17:24 Employees [NSE: writeable]\n| -rwxrwxrwx    1 ftp      ftp            41 Sep 16 17:24 Important Notes.txt [NSE: writeable]\n|_-rwxrwxrwx    1 ftp      ftp             0 Sep 15 14:57 testupload.txt [NSE: writeable]\n| ftp-syst: \n|   STAT: \n| FTP server status:\n|      Connected to 10.10.14.4\n|      Logged in as ftp\n|      TYPE: ASCII\n|      No session bandwidth limit\n|      Session timeout in seconds is 300\n|      Control connection is plain text\n|      Data connections will be plain text\n|      At session startup, client count was 2\n|      vsFTPd 3.0.3 - secure, fast, stable\n|_End of status\n```\n\nThe default script scan is based on the services' fingerprints, responses, and standard ports. Once Nmap has detected the service, it executes the marked scripts one after the other, providing different information. For example, the [ftp-anon](https://nmap.org/nsedoc/scripts/ftp-anon.html) NSE script checks whether the FTP server allows anonymous access. If so, the contents of the FTP root directory are rendered for the anonymous user.\n\nThe `ftp-syst`, for example, executes the `STAT` command, which displays information about the FTP server status. This includes configurations as well as the version of the FTP server. Nmap also provides the ability to trace the progress of NSE scripts at the network level if we use the `--script-trace` option in our scans. This lets us see what commands Nmap sends, what ports are used, and what responses we receive from the scanned server.\n\n#### Nmap Script Trace\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ sudo nmap -sV -p21 -sC -A 10.129.14.136 --script-trace\n\nStarting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 13:54 CEST                                                                                                                                                   \nNSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 8 [10.129.14.136:21]                                   \nNSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 16 [10.129.14.136:21]             \nNSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 24 [10.129.14.136:21]\nNSOCK INFO [11.4640s] nsock_trace_handler_callback(): Callback: CONNECT SUCCESS for EID 32 [10.129.14.136:21]\nNSOCK INFO [11.4640s] nsock_read(): Read request from IOD #1 [10.129.14.136:21] (timeout: 7000ms) EID 42\nNSOCK INFO [11.4640s] nsock_read(): Read request from IOD #2 [10.129.14.136:21] (timeout: 9000ms) EID 50\nNSOCK INFO [11.4640s] nsock_read(): Read request from IOD #3 [10.129.14.136:21] (timeout: 7000ms) EID 58\nNSOCK INFO [11.4640s] nsock_read(): Read request from IOD #4 [10.129.14.136:21] (timeout: 11000ms) EID 66\nNSE: TCP 10.10.14.4:54226 > 10.129.14.136:21 | CONNECT\nNSE: TCP 10.10.14.4:54228 > 10.129.14.136:21 | CONNECT\nNSE: TCP 10.10.14.4:54230 > 10.129.14.136:21 | CONNECT\nNSE: TCP 10.10.14.4:54232 > 10.129.14.136:21 | CONNECT\nNSOCK INFO [11.4660s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID 50 [10.129.14.136:21] (41 bytes): 220 Welcome to HTB-Academy FTP service...\nNSOCK INFO [11.4660s] nsock_trace_handler_callback(): Callback: READ SUCCESS for EID 58 [10.129.14.136:21] (41 bytes): 220 Welcome to HTB-Academy FTP service...\nNSE: TCP 10.10.14.4:54228 < 10.129.14.136:21 | 220 Welcome to HTB-Academy FTP service.\n```\n\nThe scan history shows that four different parallel scans are running against the service, with various timeouts. For the NSE scripts, we see that our local machine uses other output ports (`54226`, `54228`, `54230`, `54232`) and first initiates the connection with the `CONNECT` command. From the first response from the server, we can see that we are receiving the banner from the server to our second NSE script (`54228`) from the target FTP server. If necessary, we can, of course, use other applications such as `netcat` or `telnet` to interact with the FTP server.\n\n#### Service Interaction\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ nc -nv 10.129.14.136 21\n```\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ telnet 10.129.14.136 21\n```\n\nIt looks slightly different if the FTP server runs with TLS/SSL encryption. Because then we need a client that can handle TLS/SSL. For this, we can use the client `openssl` and communicate with the FTP server. The good thing about using `openssl` is that we can see the SSL certificate, which can also be helpful.\n\n  FTP\n\n```shell-session\nst8less@htb[/htb]$ openssl s_client -connect 10.129.14.136:21 -starttls ftp\n\nCONNECTED(00000003)                                                                                      \nCan't use SSL_get_servername                        \ndepth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb\nverify error:num=18:self signed certificate\nverify return:1\n\ndepth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb\nverify return:1\n---                                                 \nCertificate chain\n 0 s:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb\n \n i:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Dev, CN = master.inlanefreight.htb, emailAddress = admin@inlanefreight.htb\n---\n \nServer certificate\n\n-----BEGIN CERTIFICATE-----\n\nMIIENTCCAx2gAwIBAgIUD+SlFZAWzX5yLs2q3ZcfdsRQqMYwDQYJKoZIhvcNAQEL\n...SNIP...\n```\n\nThis is because the SSL certificate allows us to recognize the `hostname`, for example, and in most cases also an `email address` for the organization or company. In addition, if the company has several locations worldwide, certificates can also be created for specific locations, which can also be identified using the SSL certificate.","x":-400,"y":-580,"width":1220,"height":18300}
	],
	"edges":[]
}